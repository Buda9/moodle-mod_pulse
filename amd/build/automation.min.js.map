{"version":3,"file":"automation.min.js","sources":["../src/automation.js"],"sourcesContent":["define(\"mod_pulse/automation\", ['jquery', 'core/modal_factory', 'core/templates', 'core/str'], function($, Modal, Template, Str) {\n\n    const moveOutMoreMenu = (navMenu) => {\n\n        if (navMenu === null) {\n            return;\n        }\n\n        var menu = navMenu.querySelector('a.automation-templates').parentNode;\n\n        if (menu === null) {\n            return;\n        }\n        menu.dataset.forceintomoremenu = false,\n        menu.querySelector('a').classList.remove('dropdown-item');\n        menu.querySelector('a').classList.add('nav-link');\n        menu.parentNode.removeChild(menu);\n\n        // Insert the stored menus before the more menu.\n        navMenu.insertBefore(menu, navMenu.children[1]);\n        window.dispatchEvent(new Event('resize')); // Dispatch the resize event to create more menu.\n    };\n\n    const returnToFailedTab = () => {\n\n        if (document.forms['pulse-automation-template'] === null) {\n            return false;\n        }\n\n        document.forms['pulse-automation-template'].onsubmit = (e) => {\n            var form = e.target;\n            var invalidElement = form.querySelector('.is-invalid');\n            if (invalidElement === null) {\n                return true;\n            }\n\n            var tabid = invalidElement.parentNode.parentNode.parentNode.id;\n            var hrefSelector = '[href=\"#'+tabid+'\"]';\n\n            document.querySelector(hrefSelector).click();\n        }\n    };\n\n    // No need.\n    const updateAutoCompletionPositions = function() {\n        var group = \"checkboxgroupautomation\";\n\n        if (document.querySelectorAll('input[type=checkbox].'+group) === null || document.querySelectorAll('[data-fieldtype=\"autocomplete\"]') === null) {\n            return true;\n        }\n\n        document.querySelectorAll('[data-fieldtype=\"autocomplete\"]').forEach((element) => {\n\n            if (element === null) {\n                return true;\n            }\n\n            var observer = new MutationObserver(function(mutations) {\n                mutations.forEach((mutation) => {\n                    console.log(mutation);\n                    // if(mutation.type === 'attributes') {\n                    target = mutation.target;\n                    var overrideElement = target.querySelector('.custom-switch');\n                    if (overrideElement === null) {\n                        return;\n                    }\n                    overrideElement.parentNode.append(overrideElement);\n                    observer.disconnect();\n                })\n            });\n            observer.observe(element, { attributes: true, childList: true, subtree: true, });\n            // observer.disconnect();\n        })\n    }\n\n    const moveOverRidePosition = function() {\n\n        var group = \"checkboxgroupautomation\";\n\n        if (document.querySelectorAll('input[type=checkbox].'+group) === null) {\n            return true;\n        }\n\n        document.querySelectorAll('input[type=checkbox].'+group).forEach((overElement) => {\n            var id = overElement.id;\n            id = id.replace('id_override_', '');\n            var element = document.querySelector('div#fitem_id_'+id);\n            if (element === null) {\n                element = document.querySelector('div#fgroup_id_'+id);\n                if (element === null) {\n                    return true;\n                }\n            }\n\n            var parent = overElement.parentNode;\n            parent.innerHTML += '<span class=\"custom-control-label\"></span>';\n\n            var nodeToMove = document.createElement('div');\n            nodeToMove.classList.add('custom-control', 'custom-switch');\n            nodeToMove.append(parent);\n            element.querySelector(\".felement\").append(nodeToMove);\n        });\n        // Move the override button for autocompletion fields after the autocomplete nodes are created.\n        updateAutoCompletionPositions();\n    }\n\n    /**\n     * Create a modal to display the list of instances which is overriden the template setting.\n     *\n     * @returns {void}\n     */\n    const overrideModal = function() {\n\n        const trigger = document.querySelectorAll('[data-target=\"overridemodal\"]');\n\n        if (trigger === null) {\n            return;\n        }\n\n        trigger.forEach((elem) => {\n\n            elem.nextSibling.querySelector('.felement').append(elem);\n\n            elem.addEventListener('click', function(e) {\n                e.preventDefault();\n                var element = e.target;\n                var data = element.dataset;\n                var instance = document.querySelector('[name=overinstance_'+data.element+']');\n                if (instance !== null) {\n                    var overrides = JSON.parse(instance.value);\n                    overrides.map((value) => {\n                        value.url = M.cfg.wwwroot+'/mod/pulse/automation/instances/edit.php?instanceid='+value.id+'&sesskey='+M.cfg.sesskey\n                        return value;\n                    })\n                    Modal.create({\n                        title: Str.get_string('instanceoverrides', 'pulse'),\n                        body: Template.render('mod_pulse/overrides', {instances: overrides})\n                    }).then((modal) => {\n                        modal.show();\n                    });\n                }\n            })\n        })\n    };\n\n    return {\n\n        init: function() {\n            returnToFailedTab();\n            overrideModal();\n            moveOverRidePosition();\n        },\n\n        instanceMenuLink: function() {\n            var primaryNav = document.querySelector('.secondary-navigation ul.more-nav');\n            moveOutMoreMenu(primaryNav);\n        },\n\n    }\n})\n"],"names":["define","$","Modal","Template","Str","moveOverRidePosition","group","document","querySelectorAll","forEach","overElement","id","replace","element","querySelector","parent","parentNode","innerHTML","nodeToMove","createElement","classList","add","append","observer","MutationObserver","mutations","mutation","console","log","target","overrideElement","disconnect","observe","attributes","childList","subtree","updateAutoCompletionPositions","init","forms","onsubmit","e","invalidElement","hrefSelector","click","returnToFailedTab","trigger","elem","nextSibling","addEventListener","preventDefault","data","dataset","instance","overrides","JSON","parse","value","map","url","M","cfg","wwwroot","sesskey","create","title","get_string","body","render","instances","then","modal","show","overrideModal","instanceMenuLink","navMenu","menu","forceintomoremenu","remove","removeChild","insertBefore","children","window","dispatchEvent","Event","moveOutMoreMenu"],"mappings":"AAAAA,8BAA+B,CAAC,SAAU,qBAAsB,iBAAkB,aAAa,SAASC,EAAGC,MAAOC,SAAUC,WA2ElHC,qBAAuB,eAErBC,MAAQ,6BAEqD,OAA7DC,SAASC,iBAAiB,wBAAwBF,cAC3C,EAGXC,SAASC,iBAAiB,wBAAwBF,OAAOG,SAASC,kBAC1DC,GAAKD,YAAYC,GACrBA,GAAKA,GAAGC,QAAQ,eAAgB,QAC5BC,QAAUN,SAASO,cAAc,gBAAgBH,OACrC,OAAZE,SAEgB,QADhBA,QAAUN,SAASO,cAAc,iBAAiBH,YAEvC,MAIXI,OAASL,YAAYM,WACzBD,OAAOE,WAAa,iDAEhBC,WAAaX,SAASY,cAAc,OACxCD,WAAWE,UAAUC,IAAI,iBAAkB,iBAC3CH,WAAWI,OAAOP,QAClBF,QAAQC,cAAc,aAAaQ,OAAOJ,eAxDZ,cAG+B,OAA7DX,SAASC,iBAAiB,iDAA4G,OAAjED,SAASC,iBAAiB,0CACxF,EAGXD,SAASC,iBAAiB,mCAAmCC,SAASI,aAElD,OAAZA,eACO,MAGPU,SAAW,IAAIC,kBAAiB,SAASC,WACzCA,UAAUhB,SAASiB,WACfC,QAAQC,IAAIF,UAEZG,OAASH,SAASG,WACdC,gBAAkBD,OAAOf,cAAc,kBACnB,OAApBgB,kBAGJA,gBAAgBd,WAAWM,OAAOQ,iBAClCP,SAASQ,oBAGjBR,SAASS,QAAQnB,QAAS,CAAEoB,YAAY,EAAMC,WAAW,EAAMC,SAAS,OAiC5EC,UA0CG,CAEHC,KAAM,WA5HgB,SAE8B,OAAhD9B,SAAS+B,MAAM,oCACR,EAGX/B,SAAS+B,MAAM,6BAA6BC,SAAYC,QAEhDC,eADOD,EAAEX,OACaf,cAAc,kBACjB,OAAnB2B,sBACO,MAIPC,aAAe,WADPD,eAAezB,WAAWA,WAAWA,WAAWL,GACxB,KAEpCJ,SAASO,cAAc4B,cAAcC,UA6GrCC,GArCc,iBAEZC,QAAUtC,SAASC,iBAAiB,iCAE1B,OAAZqC,SAIJA,QAAQpC,SAASqC,OAEbA,KAAKC,YAAYjC,cAAc,aAAaQ,OAAOwB,MAEnDA,KAAKE,iBAAiB,SAAS,SAASR,GACpCA,EAAES,qBAEEC,KADUV,EAAEX,OACGsB,QACfC,SAAW7C,SAASO,cAAc,sBAAsBoC,KAAKrC,QAAQ,QACxD,OAAbuC,SAAmB,KACfC,UAAYC,KAAKC,MAAMH,SAASI,OACpCH,UAAUI,KAAKD,QACXA,MAAME,IAAMC,EAAEC,IAAIC,QAAQ,uDAAuDL,MAAM7C,GAAG,YAAYgD,EAAEC,IAAIE,QACrGN,SAEXtD,MAAM6D,OAAO,CACTC,MAAO5D,IAAI6D,WAAW,oBAAqB,SAC3CC,KAAM/D,SAASgE,OAAO,sBAAuB,CAACC,UAAWf,cAC1DgB,MAAMC,QACLA,MAAMC,iBAWlBC,GACAnE,wBAGJoE,iBAAkB,WAvJGC,CAAAA,aAEL,OAAZA,aAIAC,KAAOD,QAAQ5D,cAAc,0BAA0BE,WAE9C,OAAT2D,OAGJA,KAAKxB,QAAQyB,mBAAoB,EACjCD,KAAK7D,cAAc,KAAKM,UAAUyD,OAAO,iBACzCF,KAAK7D,cAAc,KAAKM,UAAUC,IAAI,YACtCsD,KAAK3D,WAAW8D,YAAYH,MAG5BD,QAAQK,aAAaJ,KAAMD,QAAQM,SAAS,IAC5CC,OAAOC,cAAc,IAAIC,MAAM,cAuI3BC,CADiB7E,SAASO,cAAc"}